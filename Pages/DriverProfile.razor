@page "/driver/{DriverNumber:int}"
<PageTitle>Driver Statistics</PageTitle>

<div class="max-w-7xl mx-auto">
    @if (isLoading)
    {
        <div class="text-center py-20">
            <p class="text-xl text-white">Loading driver statistics...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="bg-red-900 border border-red-700 rounded p-4 mb-6">
            <p class="text-white">@errorMessage</p>
        </div>
    }
    else if (driver != null)
    {
        <nav class="flex items-center gap-2 text-sm mb-6">
            <a href="./" class="text-gray-400 hover:text-white transition">Home</a>
            <span class="text-gray-600">/</span>
            <span class="text-white">@driver.FullName</span>
        </nav>

        <div class="bg-f1-gray rounded-lg p-6 mb-6">
            <div class="flex items-center gap-6">
                <img src="@driver.HeadshotUrl" alt="@driver.FullName" class="w-32 h-32 rounded-full" />
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h1 class="text-4xl font-bold text-white">@driver.FullName</h1>
                        @if (!string.IsNullOrEmpty(driver.CountryCode))
                        {
                            <img src="@GetCountryFlag(driver.CountryCode)" 
                                 alt="@driver.CountryCode" 
                                 class="w-12 h-8 object-cover rounded shadow-lg"
                                 onerror="this.style.display='none'"/>
                        }
                    </div>
                    <p class="text-xl text-gray-400">#@driver.DriverNumber - @driver.TeamName</p>
                    <div class="w-32 h-2 rounded mt-2" style="background-color: #@driver.TeamColour;"></div>
                </div>
            </div>
        </div>

        @if (isLoadingStats)
        {
            <div class="bg-f1-gray rounded-lg p-6 mb-6">
                <div class="text-center mb-4">
                    <p class="text-xl text-white font-bold mb-2">Loading Driver Statistics</p>
                    <p class="text-gray-400">Processing race @currentRaceIndex of @totalRaces</p>
                    @if (!string.IsNullOrEmpty(currentRaceName))
                    {
                        <p class="text-white font-medium mt-2">@currentRaceName</p>
                    }
                </div>
                
                <div class="w-full bg-f1-dark rounded-full h-4">
                    <div class="bg-f1-red h-4 rounded-full transition-all" style="width: @((currentRaceIndex * 100.0 / totalRaces).ToString("F1"))%"></div>
                </div>
                
                <p class="text-center text-gray-400 mt-2 text-sm">@((currentRaceIndex * 100.0 / totalRaces).ToString("F0"))% complete</p>
            </div>
        }
        }

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="bg-f1-gray rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-1">Total Races</p>
                <p class="text-3xl font-bold text-f1-red">@allStats.TotalRaces</p>
            </div>
            <div class="bg-f1-gray rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-1">Points</p>
                <p class="text-3xl font-bold text-purple-500">@allStats.Points</p>
            </div>
            <div class="bg-f1-gray rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-1">Podiums</p>
                <p class="text-3xl font-bold text-yellow-500">@allStats.Podiums</p>
            </div>
            <div class="bg-f1-gray rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-1">Best Finish</p>
                <p class="text-3xl font-bold text-green-500">@(allStats.BestPosition < 999 ? $"P{allStats.BestPosition}" : "N/A")</p>
            </div>
            <div class="bg-f1-gray rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-1">Worst Finish</p>
                <p class="text-3xl font-bold text-red-500">@(allStats.WorstPosition > 0 ? $"P{allStats.WorstPosition}" : "N/A")</p>
            </div>
            <div class="bg-f1-gray rounded-lg p-4">
                <p class="text-sm text-gray-400 mb-1">Avg Position</p>
                <p class="text-3xl font-bold text-blue-500">@(allStats.AveragePosition > 0 ? allStats.AveragePosition.ToString("F1") : "N/A")</p>
            </div>
        </div>

        <div class="bg-f1-gray rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-white">Season Breakdown</h2>
            <div class="space-y-4">
                @foreach (var season in seasonStats.OrderByDescending(s => s.Key))
                {
                    var stats = season.Value;
                    <div class="bg-f1-dark rounded-lg p-4">
                        <h3 class="text-xl font-bold mb-3 text-white">@season.Key Season</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                            <div>
                                <p class="text-sm text-gray-400">Races</p>
                                <p class="text-2xl font-bold text-white">@stats.TotalRaces</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Points</p>
                                <p class="text-2xl font-bold text-purple-500">@stats.Points</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Podiums</p>
                                <p class="text-2xl font-bold text-yellow-500">@stats.Podiums</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Best</p>
                                <p class="text-2xl font-bold text-green-500">@(stats.BestPosition < 999 ? $"P{stats.BestPosition}" : "N/A")</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Worst</p>
                                <p class="text-2xl font-bold text-red-500">@(stats.WorstPosition > 0 ? $"P{stats.WorstPosition}" : "N/A")</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-400">Avg</p>
                                <p class="text-2xl font-bold text-blue-500">@(stats.AveragePosition > 0 ? stats.AveragePosition.ToString("F1") : "N/A")</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="bg-f1-gray rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-white">Race-by-Race Breakdown</h2>
            <div class="space-y-4">
                @foreach (var season in seasonRaces.OrderByDescending(s => s.Key))
                {
                    <div class="bg-f1-dark rounded-lg overflow-hidden">
                        <button @onclick="() => ToggleSeason(season.Key)"
                                class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-700 transition text-white">
                            <span class="text-xl font-bold">@season.Key Season (@season.Value.Count races)</span>
                            <span class="text-2xl">@(expandedSeasons.Contains(season.Key) ? "−" : "+")</span>
                        </button>
                        
                        @if (expandedSeasons.Contains(season.Key))
                        {
                            <div class="p-4 space-y-2">
                                @foreach (var race in season.Value.OrderBy(r => r.RaceDate))
                                {
                                    var deltaClass = race.PositionChange > 0 ? "text-green-500" : race.PositionChange < 0 ? "text-red-500" : "text-gray-400";
                                    var arrow = race.PositionChange > 0 ? "↑" : race.PositionChange < 0 ? "↓" : "→";
                                    
                                    <div class="bg-f1-gray rounded p-3 flex items-center justify-between">
                                        <div class="flex-1">
                                            <p class="font-bold text-white">@race.RaceName</p>
                                            <p class="text-sm text-gray-400">@race.RaceDate.ToString("MMM dd, yyyy")</p>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <div class="text-center">
                                                <p class="text-xs text-gray-400">Start</p>
                                                <p class="text-lg font-bold text-white">P@(race.StartPosition)</p>
                                            </div>
                                            <span class="text-2xl @deltaClass">@arrow</span>
                                            <div class="text-center">
                                                <p class="text-xs text-gray-400">Finish</p>
                                                <p class="text-lg font-bold text-white">P@(race.FinishPosition)</p>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-xs text-gray-400">Points</p>
                                                <p class="text-lg font-bold text-purple-500">@race.Points</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>
